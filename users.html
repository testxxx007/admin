<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Users - Harbor Cellars</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: #0d0d0d;
      color: #fff;
      display: flex;
      min-height: 100vh;
    }
    a { text-decoration: none; color: inherit; }

    /* --- Sidebar --- */
    .sidebar {
      width: 220px;
      background: #111;
      display: flex;
      flex-direction: column;
      padding: 30px 20px;
      gap: 30px;
    }
    .sidebar h2 { color: #f39c12; font-size: 1.5rem; }
    .sidebar ul { list-style: none; display: flex; flex-direction: column; gap: 15px; }
    .sidebar ul li a {
      padding: 10px 15px;
      border-radius: 8px;
      transition: transform 0.3s, background 0.3s;
      display: block;
      color: #fff;
    }
    .sidebar ul li a:hover { background: #f39c12; color: #000; transform: scale(1.05); }
    .sidebar ul li a.active { background: #f39c12; color: #000; }

    /* --- Main Content --- */
    .main-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 30px;
      overflow-y: auto;
    }

    /* --- Header --- */
    .main-content h1 { font-size: 2rem; margin-bottom: 20px; color: #f39c12; }

    /* --- Sync Status Badge --- */
    .sync-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #222;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    .sync-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #27ae60;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* --- Users Table --- */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #111;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #222;
    }
    th { background: #222; }
    tr:hover { background: #222; }

    /* --- Buttons --- */
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.3s;
    }
    .btn-add { background: #f39c12; color: #000; margin-bottom: 20px; }
    .btn-edit { background: #3498db; color: #fff; margin-right: 5px; }
    .btn-delete { background: #e74c3c; color: #fff; }
    .btn:hover { transform: scale(1.05); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- Modal --- */
    .modal {
      position: fixed;
      top:0; left:0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #111;
      padding: 30px;
      border-radius: 16px;
      width: 400px;
      max-width: 90%;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .modal-content h2 {
      color: #f39c12;
      margin-bottom: 10px;
    }
    .modal-content input, .modal-content select {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: #222;
      color: #fff;
    }
    .modal-content input:focus, .modal-content select:focus {
      outline: 2px solid #f39c12;
    }
    .modal-content button { margin-top: 10px; }

    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 20px;
      color: #f39c12;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { 
        width: 100%; 
        flex-direction: row; 
        overflow-x: auto; 
        padding: 20px; 
        gap: 15px; 
      }
      .sidebar ul { flex-direction: row; gap: 15px; }
      .main-content { padding: 20px; }
      table, th, td { font-size: 0.9rem; }
      th, td { padding: 10px; }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <ul>
      <li><a href="dashboard">Dashboard</a></li>
      <li><a href="products">Products</a></li>
      <li><a href="orders">Orders</a></li>
      <li><a href="users" class="active">Users</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1>Users Management</h1>
    
    <!-- Sync Status Badge -->
    <div class="sync-status">
      <span class="sync-indicator"></span>
      <span id="syncStatusText">Syncing with Dashboard...</span>
    </div>

    <button class="btn btn-add" id="addUserBtn">Add User</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable">
        <tr><td colspan="5" class="loading">Loading users...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h2 id="modalTitle">Add User</h2>
      <input type="text" id="userName" placeholder="Full Name" required>
      <input type="email" id="userEmail" placeholder="Email" required>
      <select id="userRole">
        <option value="admin">Admin</option>
        <option value="staff">Staff</option>
        <option value="customer">Customer</option>
      </select>
      <button class="btn btn-add" id="saveUserBtn">Save</button>
      <button class="btn btn-delete" id="closeModalBtn">Cancel</button>
    </div>
  </div>

  <script>
    // GSAP animation
    if (typeof gsap !== 'undefined') {
      gsap.from(".main-content h1", { duration: 1, opacity: 0, y: -50 });
      gsap.from(".sync-status", { duration: 1, opacity: 0, x: -30, delay: 0.2 });
      gsap.from(".btn-add", { duration: 1, opacity: 0, y: -20, delay: 0.3 });
    }

    // MockAPI.io endpoint
    const API_URL = "https://68ee8cb5df2025af780412fa.mockapi.io/v1/user";

    const usersTable = document.getElementById("usersTable");
    const userModal = document.getElementById("userModal");
    const modalTitle = document.getElementById("modalTitle");
    const addUserBtn = document.getElementById("addUserBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const saveUserBtn = document.getElementById("saveUserBtn");
    const syncStatusText = document.getElementById("syncStatusText");

    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userRole = document.getElementById("userRole");

    let editId = null;
    let isSubmitting = false;
    let currentUsersData = [];
    let broadcastChannel = null;

    // Initialize BroadcastChannel
    if (typeof BroadcastChannel !== 'undefined') {
      broadcastChannel = new BroadcastChannel('harbor_admin_updates');
      console.log('✅ BroadcastChannel initialized');
    }

    // Dashboard Integration - Real-time sync function
    function notifyDashboard(eventType, data) {
      const message = {
        type: eventType,
        data: data,
        timestamp: new Date().toISOString(),
        source: 'users_page'
      };

      // Method 1: BroadcastChannel (same-origin communication)
      if (broadcastChannel) {
        try {
          broadcastChannel.postMessage(message);
          console.log('📡 BroadcastChannel message sent:', eventType);
        } catch (error) {
          console.error('BroadcastChannel error:', error);
        }
      }
      
      // Method 2: window.postMessage (for opened windows)
      if (window.opener && !window.opener.closed) {
        try {
          window.opener.postMessage(message, '*');
          console.log('📡 PostMessage sent to opener:', eventType);
        } catch (error) {
          console.error('PostMessage error:', error);
        }
      }

      // Method 3: Try to access parent window
      if (window.parent && window.parent !== window) {
        try {
          window.parent.postMessage(message, '*');
          console.log('📡 PostMessage sent to parent:', eventType);
        } catch (error) {
          console.error('PostMessage to parent error:', error);
        }
      }
      
      console.log('📊 Dashboard notification:', eventType, data);
    }

    // Dashboard Integration - Users data sync
    function syncUsersToDashboard(users) {
      currentUsersData = users;
      
      const syncData = {
        totalUsers: users.length,
        usersByRole: {
          admin: users.filter(u => u.role === 'admin').length,
          staff: users.filter(u => u.role === 'staff').length,
          customer: users.filter(u => u.role === 'customer').length
        },
        users: users.map(u => ({
          id: u.id,
          name: u.name,
          email: u.email,
          role: u.role,
          createdAt: u.createdAt
        })),
        lastSync: new Date().toISOString()
      };

      notifyDashboard('users_updated', syncData);
      updateSyncStatus(`Synced ${users.length} users`);
    }

    // Dashboard Integration - Activity logging
    function logActivity(message, type = 'info', details = {}) {
      const activityData = {
        message,
        type,
        details,
        timestamp: new Date().toISOString(),
        page: 'users'
      };

      notifyDashboard('activity_logged', activityData);
      console.log('📝 Activity logged:', message, type);
    }

    // Update sync status badge
    function updateSyncStatus(text) {
      syncStatusText.textContent = text;
      setTimeout(() => {
        syncStatusText.textContent = 'Live sync active';
      }, 3000);
    }

    // Fetch users from MockAPI
    async function fetchUsers() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Failed to fetch users');
        const users = await response.json();
        
        // Dashboard ကို real-time sync
        syncUsersToDashboard(users);
        
        renderUsers(users);
        logActivity(`${users.length} users loaded from API`, 'info', { count: users.length });
      } catch (error) {
        console.error("Error fetching users:", error);
        usersTable.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#e74c3c;">Failed to load users. Please refresh the page.</td></tr>';
        logActivity('Failed to load users', 'error', { error: error.message });
        updateSyncStatus('Sync failed');
      }
    }

    function renderUsers(users) {
      if (!users || users.length === 0) {
        usersTable.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#aaa;">No users found</td></tr>';
        return;
      }

      usersTable.innerHTML = "";
      users.forEach(user => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${user.id || 'N/A'}</td>
          <td>${user.name || 'N/A'}</td>
          <td>${user.email || 'N/A'}</td>
          <td><span style="background:#${user.role === 'admin' ? 'e74c3c' : user.role === 'staff' ? '3498db' : '27ae60'};padding:4px 12px;border-radius:12px;font-size:0.85rem;">${user.role || 'N/A'}</span></td>
          <td>
            <button class="btn btn-edit" onclick="editUser('${user.id}')">Edit</button>
            <button class="btn btn-delete" onclick="deleteUser('${user.id}')">Delete</button>
          </td>
        `;
        usersTable.appendChild(row);
      });
    }

    function openModal() { 
      userModal.classList.add("active");
      setTimeout(() => userName.focus(), 100);
    }

    function closeModal() {
      userModal.classList.remove("active");
      userName.value = "";
      userEmail.value = "";
      userRole.value = "admin";
      editId = null;
      isSubmitting = false;
      saveUserBtn.disabled = false;
      saveUserBtn.textContent = "Save";
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    addUserBtn.addEventListener("click", () => {
      modalTitle.textContent = "Add User";
      editId = null;
      openModal();
    });

    closeModalBtn.addEventListener("click", closeModal);

    userModal.addEventListener("click", (e) => {
      if (e.target === userModal) closeModal();
    });

    saveUserBtn.addEventListener("click", async () => {
      if (isSubmitting) return;

      const name = userName.value.trim();
      const email = userEmail.value.trim();
      const role = userRole.value;

      if (!name || !email || !role) {
        alert("Please fill in all fields!");
        return;
      }

      if (!isValidEmail(email)) {
        alert("Please enter a valid email address!");
        return;
      }

      isSubmitting = true;
      saveUserBtn.disabled = true;
      saveUserBtn.textContent = "Saving...";

      try {
        let response;
        if (editId) {
          response = await fetch(`${API_URL}/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, role })
          });
          logActivity(`User updated: ${name}`, 'update', { userId: editId, email, role });
        } else {
          response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, role })
          });
          logActivity(`New user added: ${name}`, 'create', { email, role });
        }

        if (!response.ok) throw new Error('Failed to save user');

        await fetchUsers(); // Dashboard ကို auto sync လုပ်မယ်
        closeModal();
        alert(editId ? "User updated successfully!" : "User added successfully!");
      } catch (error) {
        console.error("Error saving user:", error);
        logActivity('Failed to save user', 'error', { error: error.message });
        alert("Failed to save user. Please check your connection and try again.");
      } finally {
        isSubmitting = false;
        saveUserBtn.disabled = false;
        saveUserBtn.textContent = "Save";
      }
    });

    window.editUser = async function(id) {
      try {
        const response = await fetch(`${API_URL}/${id}`);
        if (!response.ok) throw new Error('Failed to fetch user');
        const user = await response.json();
        
        editId = id;
        modalTitle.textContent = "Edit User";
        userName.value = user.name || "";
        userEmail.value = user.email || "";
        userRole.value = user.role || "admin";
        openModal();
        
        logActivity(`Editing user: ${user.name}`, 'info', { userId: id });
      } catch (error) {
        console.error("Error fetching user:", error);
        alert("Failed to load user data. Please try again.");
      }
    };

    window.deleteUser = async function(id) {
      if (!confirm("Are you sure you want to delete this user?")) {
        return;
      }

      try {
        // User info ကို delete မလုပ်ခင် သိမ်းထားမယ်
        const userToDelete = currentUsersData.find(u => u.id === id);
        
        const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete user');
        
        logActivity(`User deleted: ${userToDelete?.name || 'Unknown'}`, 'delete', { 
          userId: id,
          email: userToDelete?.email,
          role: userToDelete?.role
        });
        
        await fetchUsers(); // Dashboard ကို auto sync လုပ်မယ်
        alert("User deleted successfully!");
      } catch (error) {
        console.error("Error deleting user:", error);
        logActivity('Failed to delete user', 'error', { userId: id, error: error.message });
        alert("Failed to delete user. Please try again.");
      }
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && userModal.classList.contains('active')) {
        closeModal();
      }
    });

    // Dashboard မှာ ပြန်ပို့လာတဲ့ messages တွေ နားထောင်မယ်
    window.addEventListener('message', (event) => {
      // Security: Production မှာ origin check လုပ်သင့်တယ်
      // if (event.origin !== 'https://yourdomain.com') return;
      
      if (event.data && event.data.type === 'request_user_data') {
        console.log('📩 Dashboard requested user data via postMessage');
        if (currentUsersData.length > 0) {
          syncUsersToDashboard(currentUsersData);
        } else {
          fetchUsers(); // Data မရှိရင် fetch ပြန်လုပ်မယ်
        }
      }
    });

    // BroadcastChannel နဲ့ Dashboard ကနေ request လာရင် response ပြန်မယ်
    if (broadcastChannel) {
      broadcastChannel.addEventListener('message', (event) => {
        if (event.data.type === 'request_user_data') {
          console.log('📩 Dashboard requested user data via BroadcastChannel');
          if (currentUsersData.length > 0) {
            syncUsersToDashboard(currentUsersData);
          } else {
            fetchUsers();
          }
        }
        
        if (event.data.type === 'ping') {
          console.log('🏓 Received ping from Dashboard');
          notifyDashboard('pong', { status: 'active', users: currentUsersData.length });
        }
      });
    }

    // Page visible ဖြစ်တဲ့အခါ Dashboard ကို notify လုပ်မယ်
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUsersData.length > 0) {
        syncUsersToDashboard(currentUsersData);
        logActivity('Users page became visible', 'navigation');
      }
    });

    // Periodic sync every 30 seconds (optional)
    setInterval(() => {
      if (!document.hidden && currentUsersData.length > 0) {
        syncUsersToDashboard(currentUsersData);
      }
    }, 30000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (broadcastChannel) {
        logActivity('Users page closed', 'navigation');
        broadcastChannel.close();
      }
    });

    // Initial load
    fetchUsers();
    logActivity('Users page opened', 'navigation');
    updateSyncStatus('Connecting...');
    
    console.log('🚀 Users Management System Initialized');
    console.log('📡 Real-time sync enabled with Dashboard');
  </script>
</body>
</html>